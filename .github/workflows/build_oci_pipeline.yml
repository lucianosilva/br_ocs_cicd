# Nome do Workflow
name: Terraform OCI Pipeline

# Evento que irÃ¡ acionar a pipeline (actions)
on: 
  push:
    branches:
      - main

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Install Requirements
        run: pip install -r requirements.txt
 
      - name: Unit Test
        run: python -m unittest -v test
  
      - name: Write Config & Key Files
        run: |
          mkdir ~/.oci/
          touch ~/.oci/key.pem
          echo "${{secrets.OCI_PRIVATE_KEY}}" >> ~/.oci/key.pem

          touch ~/env-vars.sh
          echo "#!/bin/sh" >> ~/env-vars.sh
          echo "# Required for the OCI Provider" >> ~/env-vars.sh
          echo "export TF_VAR_tenancy_ocid=${{secrets.OCI_TENANCY_ID}}" >> ~/env-vars.sh
          echo "export TF_VAR_compartment_ocid=${{secrets.OCI_COMPARTMENT_ID}}" >> ~/env-vars.sh          
          echo "export TF_VAR_user_ocid=${{secrets.OCI_USER_ID}}" >> ~/env-vars.sh
          echo "export TF_VAR_fingerprint=${{secrets.OCI_FINGERPRINT}}" >> ~/env-vars.sh
          echo "export TF_VAR_private_key_path=~/.oci/key.pem" >> ~/env-vars.sh
          echo "export TF_VAR_region=${{secrets.OCI_REGION}}" >> ~/env-vars.sh
          echo "# Keys used to SSH to OCI VMs" >> ~/env-vars.sh
          echo "export TF_VAR_ssh_public_key=${{secrets.OCI_SSH_PUB_KEY}}" >> ~/env-vars.sh
          echo "export TF_VAR_ssh_private_key=${{secrets.OCI_SSH_PRIV_KEY}}" >> ~/env-vars.sh

      - name: Terraform
        run: |
          terraform init
          terraform plan
          terraform apply



